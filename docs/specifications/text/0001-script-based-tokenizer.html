<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Welcome to the Meilisearch dev specifications!</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.b26ff90a.css" as="style"><link rel="preload" href="/assets/js/app.14e18415.js" as="script"><link rel="preload" href="/assets/js/3.7860be15.js" as="script"><link rel="preload" href="/assets/js/13.569b541d.js" as="script"><link rel="prefetch" href="/assets/js/10.867f19e5.js"><link rel="prefetch" href="/assets/js/11.729a6b35.js"><link rel="prefetch" href="/assets/js/12.3fc27b6c.js"><link rel="prefetch" href="/assets/js/14.5eb4b1a7.js"><link rel="prefetch" href="/assets/js/15.ffba3d85.js"><link rel="prefetch" href="/assets/js/16.5bbcf611.js"><link rel="prefetch" href="/assets/js/17.052e3dd6.js"><link rel="prefetch" href="/assets/js/18.1930f072.js"><link rel="prefetch" href="/assets/js/19.1ce2f361.js"><link rel="prefetch" href="/assets/js/20.bbf42276.js"><link rel="prefetch" href="/assets/js/21.2d9b101a.js"><link rel="prefetch" href="/assets/js/22.1f07eccb.js"><link rel="prefetch" href="/assets/js/23.49f62338.js"><link rel="prefetch" href="/assets/js/24.bdd429da.js"><link rel="prefetch" href="/assets/js/25.d65be380.js"><link rel="prefetch" href="/assets/js/26.d95b24bd.js"><link rel="prefetch" href="/assets/js/27.657689b8.js"><link rel="prefetch" href="/assets/js/28.6d50322d.js"><link rel="prefetch" href="/assets/js/29.28370923.js"><link rel="prefetch" href="/assets/js/30.9828f922.js"><link rel="prefetch" href="/assets/js/31.58809cac.js"><link rel="prefetch" href="/assets/js/32.733e95db.js"><link rel="prefetch" href="/assets/js/33.fbc8f9dc.js"><link rel="prefetch" href="/assets/js/34.bda1b03c.js"><link rel="prefetch" href="/assets/js/35.543c03a1.js"><link rel="prefetch" href="/assets/js/36.e60a6e3a.js"><link rel="prefetch" href="/assets/js/37.2e37d485.js"><link rel="prefetch" href="/assets/js/38.d9bfbb6f.js"><link rel="prefetch" href="/assets/js/39.c6446eba.js"><link rel="prefetch" href="/assets/js/4.3d6ce9d6.js"><link rel="prefetch" href="/assets/js/40.ac463bc0.js"><link rel="prefetch" href="/assets/js/41.9efc1325.js"><link rel="prefetch" href="/assets/js/42.578ced59.js"><link rel="prefetch" href="/assets/js/43.d2b6d075.js"><link rel="prefetch" href="/assets/js/44.a2214c33.js"><link rel="prefetch" href="/assets/js/45.2c7442dc.js"><link rel="prefetch" href="/assets/js/46.c82eebd0.js"><link rel="prefetch" href="/assets/js/47.42c0150d.js"><link rel="prefetch" href="/assets/js/48.02b2c80a.js"><link rel="prefetch" href="/assets/js/49.c3c4d010.js"><link rel="prefetch" href="/assets/js/5.06848b4d.js"><link rel="prefetch" href="/assets/js/50.20f74a2a.js"><link rel="prefetch" href="/assets/js/51.876e1cfd.js"><link rel="prefetch" href="/assets/js/6.87f02c74.js"><link rel="prefetch" href="/assets/js/7.fadbe260.js"><link rel="prefetch" href="/assets/js/8.d45b99a8.js"><link rel="prefetch" href="/assets/js/9.0c014273.js"><link rel="prefetch" href="/assets/js/vendors~docs-searchbar.9a2822a3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b26ff90a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Welcome to the Meilisearch dev specifications!</span></a> <div class="links"><form id="search-form" role="search" class="meilisearch-search-wrapper search-box"><input id="meilisearch-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/specifications/text/specifications/text/0000-specification-template.html" class="nav-link">
  Specification
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/specifications/text/specifications/text/0000-specification-template.html" class="nav-link">
  Specification
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/specifications/text/0000-specification-template.html" class="sidebar-link">Specification template</a></li><li><a href="/specifications/text/0001-frontend-disable-prod.html" class="sidebar-link">Frontend disable prod</a></li><li><a href="/specifications/text/0001-script-based-tokenizer.html" aria-current="page" class="active sidebar-link">Script based tokenizer</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/specifications/text/0001-script-based-tokenizer.html#feature-description-and-interaction" class="sidebar-link">Feature Description and Interaction</a></li><li class="sidebar-sub-header"><a href="/specifications/text/0001-script-based-tokenizer.html#technical-specifications" class="sidebar-link">Technical Specifications</a></li><li class="sidebar-sub-header"><a href="/specifications/text/0001-script-based-tokenizer.html#future-possibilities" class="sidebar-link">Future possibilities</a></li></ul></li><li><a href="/specifications/text/0028-indexing-csv.html" class="sidebar-link">Indexing csv</a></li><li><a href="/specifications/text/0029-indexing-ndjson.html" class="sidebar-link">Indexing ndjson</a></li><li><a href="/specifications/text/0030-asc-desc-criterion.html" class="sidebar-link">Asc desc criterion</a></li><li><a href="/specifications/text/0032-distinct-attribute.html" class="sidebar-link">Distinct attribute</a></li><li><a href="/specifications/text/0033-logging.html" class="sidebar-link">Logging</a></li><li><a href="/specifications/text/0034-telemetry-policies.html" class="sidebar-link">Telemetry policies</a></li><li><a href="/specifications/text/0036-exactness-criterion.html" class="sidebar-link">Exactness criterion</a></li><li><a href="/specifications/text/0038-rename-attributes-for-faceting.html" class="sidebar-link">Rename attributes for faceting</a></li><li><a href="/specifications/text/0043-phrase-query.html" class="sidebar-link">Phrase query</a></li><li><a href="/specifications/text/0047-reset-stop-words-synonyms-settings-with-null.html" class="sidebar-link">Reset stop words synonyms settings with null</a></li><li><a href="/specifications/text/0048-rename-max-mdb-size-var.html" class="sidebar-link">Rename max mdb size var</a></li><li><a href="/specifications/text/0055-sort.html" class="sidebar-link">Sort</a></li><li><a href="/specifications/text/0059-geo-search.html" class="sidebar-link">Geo search</a></li><li><a href="/specifications/text/0060-tasks-api.html" class="sidebar-link">Tasks api</a></li><li><a href="/specifications/text/0061-error-format-and-definitions.html" class="sidebar-link">Error format and definitions</a></li><li><a href="/specifications/text/0077-words-position-limit.html" class="sidebar-link">Words position limit</a></li><li><a href="/specifications/text/0085-api-keys.html" class="sidebar-link">Api keys</a></li><li><a href="/specifications/text/0089-tenant-tokens.html" class="sidebar-link">Tenant tokens</a></li><li><a href="/specifications/text/0096-auto-batching.html" class="sidebar-link">Auto batching</a></li><li><a href="/specifications/text/0105-dumps-api.html" class="sidebar-link">Dumps api</a></li><li><a href="/specifications/text/0117-typo-tolerance-setting-api.html" class="sidebar-link">Typo tolerance setting api</a></li><li><a href="/specifications/text/0118-search-api.html" class="sidebar-link">Search api</a></li><li><a href="/specifications/text/0119-instance-options.html" class="sidebar-link">Instance options</a></li><li><a href="/specifications/text/0121-data-types.html" class="sidebar-link">Data types</a></li><li><a href="/specifications/text/0123-displayed-attributes-setting-api.html" class="sidebar-link">Displayed attributes setting api</a></li><li><a href="/specifications/text/0123-distinct-attribute-setting-api.html" class="sidebar-link">Distinct attribute setting api</a></li><li><a href="/specifications/text/0123-filterable-attributes-setting-api.html" class="sidebar-link">Filterable attributes setting api</a></li><li><a href="/specifications/text/0123-ranking-rules-setting-api.html" class="sidebar-link">Ranking rules setting api</a></li><li><a href="/specifications/text/0123-searchable-attributes-setting-api.html" class="sidebar-link">Searchable attributes setting api</a></li><li><a href="/specifications/text/0123-settings-api.html" class="sidebar-link">Settings api</a></li><li><a href="/specifications/text/0123-sortable-attributes-setting-api.html" class="sidebar-link">Sortable attributes setting api</a></li><li><a href="/specifications/text/0123-stop-words-setting-api.html" class="sidebar-link">Stop words setting api</a></li><li><a href="/specifications/text/0123-synonyms-setting-api.html" class="sidebar-link">Synonyms setting api</a></li><li><a href="/specifications/text/0124-documents-api.html" class="sidebar-link">Documents api</a></li><li><a href="/specifications/text/0132-indexes-api.html" class="sidebar-link">Indexes api</a></li><li><a href="/specifications/text/0134-stats-api.html" class="sidebar-link">Stats api</a></li><li><a href="/specifications/text/157-faceting-setting-api.html" class="sidebar-link">Aceting setting api</a></li><li><a href="/specifications/text/157-pagination-setting-api.html" class="sidebar-link">Agination setting api</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><ul><li>Title: Script Based Tokenizer</li> <li>Start Date: 2020-10-27</li> <li>specification PR: meilisearch/specifications#2</li> <li>Meilisearch Issue: meilisearch/Meilsearch#624</li></ul> <h2 id="feature-description-and-interaction"><a href="#feature-description-and-interaction" class="header-anchor">#</a> Feature Description and Interaction</h2> <h3 id="summary"><a href="#summary" class="header-anchor">#</a> Summary</h3> <p>The first step of document indexing in the Meilisearch engine is tokenization. Tokenization is the action of taking a sentence and splitting it in units of language called tokens. The tokenization task is highly language dependant and is a critical factor in the quality of the search results.</p> <h3 id="motivation"><a href="#motivation" class="header-anchor">#</a> Motivation</h3> <p>We want to provide our users with an always improved searching experience. For that matter, it is critical for us to improve the performance of our tokenizer, and to provide better support for multilingual tokenization.</p> <h3 id="prior-art-and-r-d"><a href="#prior-art-and-r-d" class="header-anchor">#</a> Prior Art and R&amp;D</h3> <p><strong>tokenization:</strong></p> <ul><li><blockquote><p><strong><a href="https://github.com/unicode-rs/unicode-segmentation" target="_blank" rel="noopener noreferrer">unicode-segmentation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>:</strong>
tokenizer which follow the <a href="http://www.unicode.org/reports/tr29/" target="_blank" rel="noopener noreferrer">Standard Annex #29: Unicode Text Segmentation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>,
this tokenizer seems promising for Latin scripts.</p></blockquote></li> <li><blockquote><p><strong><a href="https://github.com/messense/jieba-rs" target="_blank" rel="noopener noreferrer">Jieba<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>:</strong>
tokenizer specialized in Chinese languages</p></blockquote></li> <li><blockquote><p><strong><a href="https://github.com/lindera-morphology/lindera" target="_blank" rel="noopener noreferrer">Lindera<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>:</strong>
Japanese and Korean</p></blockquote></li></ul> <p><strong>lang/script detection:</strong></p> <ul><li><blockquote><p><strong><a href="https://github.com/greyblake/whatlang-rs" target="_blank" rel="noopener noreferrer">whatlang<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>:</strong>
whatlang is able to detect script or/and language in a text,
language detection is low but the script is acceptable.
note: Sonic also uses whatlang to perform the tokenization, it could be interesting to check out how they do it.</p></blockquote></li> <li><blockquote><p><strong>toku (@qdequele):</strong>
in a R&amp;D project, @qdequele was able to detect language based on stop word distribution in a text.
If, in a latin script, there is lot of French stop words then the text language is probably french.</p></blockquote></li></ul> <p><strong>other solution that advertise multilingual support:</strong></p> <ul><li>Sonic uses whatlang to perform the tokenization, it could be interesting to checkout how they do it: https://github.com/valeriansaliou/sonic/tree/master/src/lexer
<ul><li>Sonic uses whatlang to detect the languages but doesn't actually seem to use it to segment the text. It simply uses unicode segmentation, I can't really explain what they actually do with the language information.</li></ul></li> <li>tantivy advertise good multilingual support: https://github.com/tantivy-search/tantivy/tree/main/src/tokenizer
<ul><li>Tantivy is similar to elastic in the sense that you can set up a custom text analyzer. The difference is that it is only made of <code>tokenizer</code> -&gt; <code>token_filter</code>. Tantivy also provides a collection of tokenizer to choose from. Tokens are rather simple and do not contain any metadata, except for their position.</li></ul></li> <li>How elastic search handle it: https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-tokenizers.html:
<ul><li>Elastic proposed to create custom text analyzer. A text analyzer is a pipelined text processor with the following components: <code>char_filter</code> -&gt; <code>tokenizer</code> -&gt; <code>token_filter</code>. There are multiple different tokenizers that can be chosen, depending on the use-case. This is a bit complicated, but I also think that advanced users should be able to choose the tokenizer they want. (default behavior is us guessing what's the best tokenizer to use.)</li></ul></li> <li>Algolia:
<ul><li>Algolia uses multiple techniques to handle tokenization. They start by <a href="https://www.algolia.com/doc/guides/managing-results/optimize-search-results/handling-natural-languages-nlp/in-depth/normalization/" target="_blank" rel="noopener noreferrer">normalizing<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> the text (lowercase, unidecode, transform traditional Chinese to modern, etc). Then, they tokenize the normalized data. It seems that the tokenization is based on two techniques. The first one is by <a href="https://www.algolia.com/doc/guides/managing-results/optimize-search-results/handling-natural-languages-nlp/in-depth/tokenization/" target="_blank" rel="noopener noreferrer">defining separators<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (space, comma, carriage return, etc) and the other one is with <a href="https://www.algolia.com/doc/guides/managing-results/optimize-search-results/handling-natural-languages-nlp/#using-dictionaries" target="_blank" rel="noopener noreferrer">dictionaries<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. The language is not automatically detected, <a href="https://www.algolia.com/doc/guides/managing-results/optimize-search-results/handling-natural-languages-nlp/#no-automatic-language-detection" target="_blank" rel="noopener noreferrer">it must be set by the user<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. They also have dictionaries for plurals.</li></ul></li></ul> <h3 id="explanation"><a href="#explanation" class="header-anchor">#</a> Explanation</h3> <p>In order to use the tokenizer, all the user has to do is to instantiate a <code>Tokenizer</code>, call <code>tokenize(&amp;str)</code> on it and iterate over the emitted tokens:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> stop_words <span class="token operator">=</span> <span class="token class-name">Set</span><span class="token punctuation">::</span><span class="token function">from_iter</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;the&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;of&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> analyzer <span class="token operator">=</span> <span class="token class-name">Analyzer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">AnalyzerConfig</span><span class="token punctuation">::</span><span class="token function">default_with_stopwords</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stop_words<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> orig <span class="token operator">=</span> <span class="token string">&quot;The quick (\&quot;brown\&quot;) fox can't jump 32.3 feet, right? Brr, it's 29.3Â°F!&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> analyzed <span class="token operator">=</span> analyzer<span class="token punctuation">.</span><span class="token function">analyze</span><span class="token punctuation">(</span>orig<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token keyword">mut</span> analyzed <span class="token operator">=</span> analyzed<span class="token punctuation">.</span><span class="token function">tokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token string">&quot;the&quot;</span><span class="token punctuation">,</span> analyzed<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">,</span> analyzed<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token string">&quot;quick&quot;</span><span class="token punctuation">,</span> analyzed<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">,</span> analyzed<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token string">&quot;(&quot;</span><span class="token punctuation">,</span> analyzed<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token string">&quot;\&quot;&quot;</span><span class="token punctuation">,</span> analyzed<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token string">&quot;brown&quot;</span><span class="token punctuation">,</span> analyzed<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The call to the tokenize method allows the reuse of the same <code>Tokenizer</code> instance, and keep its configuration state and allocations.</p> <p>Below are examples of the integration of the new tokenizer in existing code:</p> <ul><li>Highlight in @kerollmops milli:</li></ul> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// new tokenizer</span>
<span class="token keyword">fn</span> <span class="token function-definition function">highlight_record</span><span class="token punctuation">(</span>record<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">IndexMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> words<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">let</span> stop_words <span class="token operator">=</span> <span class="token class-name">Set</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> analyzer <span class="token operator">=</span> <span class="token class-name">Analyzer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">AnalyzerConfig</span><span class="token punctuation">::</span><span class="token function">default_with_stopwords</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stop_words<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>_key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token keyword">in</span> record<span class="token punctuation">.</span><span class="token function">iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> old_value <span class="token operator">=</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">take</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> analyzed <span class="token operator">=</span> analyzer<span class="token punctuation">.</span><span class="token function">analyze</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>old_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">for</span> <span class="token punctuation">(</span>original<span class="token punctuation">,</span> token<span class="token punctuation">)</span> <span class="token keyword">in</span> analyzed<span class="token punctuation">.</span><span class="token function">reconstruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> token<span class="token punctuation">.</span><span class="token function">is_word</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> to_highlight <span class="token operator">=</span> words<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>token<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> to_highlight <span class="token punctuation">{</span> value<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;mark&gt;&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
                value<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> to_highlight <span class="token punctuation">{</span> value<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;/mark&gt;&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                value<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// original</span>
<span class="token keyword">fn</span> <span class="token function-definition function">highlight_record</span><span class="token punctuation">(</span>record<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">IndexMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> words<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>_key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token keyword">in</span> record<span class="token punctuation">.</span><span class="token function">iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> old_value <span class="token operator">=</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">take</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>token_type<span class="token punctuation">,</span> token<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token function">simple_tokenizer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>old_value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> token_type <span class="token operator">==</span> <span class="token class-name">TokenType</span><span class="token punctuation">::</span><span class="token class-name">Word</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> lowercase_token <span class="token operator">=</span> token<span class="token punctuation">.</span><span class="token function">to_lowercase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> to_highlight <span class="token operator">=</span> words<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lowercase_token<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> to_highlight <span class="token punctuation">{</span> value<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;mark&gt;&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
                value<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> to_highlight <span class="token punctuation">{</span> value<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;/mark&gt;&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                value<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>As we can see, the changes that need to be made are very minimal: this is because efforts have been made to make its API close to the previous one.</p> <h3 id="impact-on-documentation"><a href="#impact-on-documentation" class="header-anchor">#</a> Impact on documentation</h3> <p>This feature should not impact meilisearch users' documentation.
In future versions, we will probably provide a way to configure tokenizer and this will be discussed in a new specification.</p> <h2 id="technical-specifications"><a href="#technical-specifications" class="header-anchor">#</a> Technical Specifications</h2> <h3 id="architecture"><a href="#architecture" class="header-anchor">#</a> Architecture</h3> <p>The new version of the tokenizer will replace the current version as a standalone library.</p> <p><img src="https://user-images.githubusercontent.com/6482087/102896344-8560d200-4466-11eb-8cfe-b4ae8741093b.jpg" alt="Tokenizer"></p> <h3 id="implementation-details"><a href="#implementation-details" class="header-anchor">#</a> Implementation Details</h3> <p>We want to support different tokenizers based on the language of the text that needs to be indexed. For this, we may need to change the tokenizer we are using while indexing, depending on the language and the script, detected by <code>whatlang</code>. The Analyzer provides an interface that abstracts this need away from the consumer of the tokens.</p> <h4 id="pipeline"><a href="#pipeline" class="header-anchor">#</a> Pipeline</h4> <p>A pipeline is a structure that contains all the steps needed to tokenize a specific language or script:</p> <ul><li>One or several preprocessors to prepare text before tokenization e.g. traditional Chinese translation or erasing some characters;</li> <li>A tokenizer to transform the text into an iterator of tokens;</li> <li>One or several normalizers to normalize tokens for indexation e.g. deunicode or lowercase.</li></ul> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Pipeline</span> <span class="token punctuation">{</span>
    pre_processor<span class="token punctuation">:</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">PreProcessor</span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'static</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    tokenizer<span class="token punctuation">:</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">Tokenizer</span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'static</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    normalizer<span class="token punctuation">:</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">Normalizer</span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'static</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="configuration"><a href="#configuration" class="header-anchor">#</a> Configuration</h4> <p>The tokenizer is configured at initialization. A <code>Default</code> implementation is provided with the settings we believe suits most cases.
The configuration options, for now, are:</p> <ul><li>the <code>stop_words</code></li> <li>the <code>pipeline_map</code> that links a <code>(Script, Language)</code> to a <code>Pipeline</code>. This defaults to the mapping we find the best fitting for most cases. These settings should be left as is now, but will allow the user to define Pipelines in the future.</li></ul> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">AnalyzerConfig</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">/// language specialized pipeline, this can be switched during</span>
    <span class="token comment">/// document tokenization if the document contains several languages</span>
    <span class="token keyword">pub</span> pipeline_map<span class="token punctuation">:</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token class-name">Script</span><span class="token punctuation">,</span> <span class="token class-name">Language</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Pipeline</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> stop_words<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">Set</span><span class="token operator">&lt;</span><span class="token class-name">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="analyzer"><a href="#analyzer" class="header-anchor">#</a> Analyzer</h4> <p>The analyzer exposes an abstracted interface to the tokenization process. Its API is standard:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>token<span class="token punctuation">::</span></span><span class="token class-name">Token</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>tokenizer<span class="token punctuation">::</span></span><span class="token class-name">Tokenizer</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Analyzer</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    config<span class="token punctuation">:</span> <span class="token class-name">AnalyzerConfig</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">A</span><span class="token operator">&gt;</span> <span class="token class-name">Analyzer</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">A</span><span class="token operator">&gt;</span>
<span class="token keyword">where</span>
    <span class="token class-name">A</span><span class="token punctuation">:</span> <span class="token class-name">AsRef</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token comment">/// create a new tokenizer detecting script</span>
    <span class="token comment">/// and chose the specialized internal tokenizer</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>config<span class="token punctuation">:</span> <span class="token class-name">AnalyzerConfig</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">A</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span> <span class="token macro property">unimplemented!</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>

    <span class="token comment">/// Builds an `AnalyzedText` instance with the correct analyzer pipeline, and pre-processes the</span>
    <span class="token comment">/// text.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// If an analysis pipeline exists for the inferred `(Script, Language)`, the analyzer will look</span>
    <span class="token comment">/// for a user specified default `(Script::Other, Language::Other)`. If the user default is not</span>
    <span class="token comment">/// specified, it will fallback to `(IdentityPreProcessor, UnicodeSegmenter, IdentityNormalizer)`.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// ```rust</span>
    <span class="token comment">/// use meilisearch_tokenizer::{Analyzer, AnalyzerConfig};</span>
    <span class="token comment">/// use fst::Set;</span>
    <span class="token comment">/// // defaults to unicode segmenter with identity preprocessor and normalizer.</span>
    <span class="token comment">/// let stop_words = Set::from_iter([&quot;&quot;].iter()).unwrap();</span>
    <span class="token comment">/// let analyzer = Analyzer::new(AnalyzerConfig::default_with_stopwords(&amp;stop_words));</span>
    <span class="token comment">/// let analyzed = analyzer.analyze(&quot;The quick (\&quot;brown\&quot;) fox can't jump 32.3 feet, right? Brr, it's 29.3Â°F!&quot;);</span>
    <span class="token comment">/// let mut tokens = analyzed.tokens();</span>
    <span class="token comment">/// assert!(&quot;the&quot; == tokens.next().unwrap().text());</span>
    <span class="token comment">/// ```</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">analyze</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'t</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'t</span> <span class="token keyword">self</span><span class="token punctuation">,</span> text<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'t</span> <span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">AnalyzedText</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'t</span><span class="token punctuation">,</span> <span class="token class-name">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token macro property">unimplemented!</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/// result of analyzer.analyze() function, made to choose how tokens will be returned.</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">AnalyzedText</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">A</span><span class="token operator">&gt;</span> <span class="token class-name">AnalyzedText</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">A</span><span class="token operator">&gt;</span>
<span class="token keyword">where</span>
    <span class="token class-name">A</span><span class="token punctuation">:</span> <span class="token class-name">AsRef</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token comment">/// Returns a `TokenStream` for the Analyzed text.</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">tokens</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">TokenStream</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token macro property">unimplemented!</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>

    <span class="token comment">/// Attaches each token to its corresponding portion of the original text.</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">reconstruct</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">impl</span> <span class="token class-name">Iterator</span><span class="token operator">&lt;</span><span class="token class-name">Item</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span><span class="token punctuation">,</span> <span class="token class-name">Token</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">&gt;</span>  <span class="token punctuation">{</span> <span class="token macro property">unimplemented!</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="token"><a href="#token" class="header-anchor">#</a> Token</h4> <p>The <code>Token</code> is is the result of an iteration of the <code>Analyzer</code>,
it wraps a <code>&amp;str</code>, a byte slice containing one or several characters, with some informations about:</p> <ul><li>the <code>kind: TokenKind</code> defining if the token is a <code>Word</code>, a <code>Separator</code> or a <code>StopWord</code></li> <li>the <code>char_index: usize</code> defining the index of the first character of the <code>Token</code> in the whole original text</li> <li>the <code>byte_start/byte_end: usize</code> defining the indexes of start and end of the byte slice in the whole original text</li></ul> <p>â ï¸ The wrapped byte slice should not be considered as a subset of the original text
but as a normalized version of the subset.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[derive(Debug, Clone, Copy, PartialEq, Eq)]</span>
<span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">SeparatorKind</span> <span class="token punctuation">{</span>
    <span class="token class-name">Hard</span><span class="token punctuation">,</span>
    <span class="token class-name">Soft</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[derive(Debug, Clone, Copy, PartialEq)]</span>
<span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">TokenKind</span> <span class="token punctuation">{</span>
    <span class="token class-name">Word</span><span class="token punctuation">,</span>
    <span class="token comment">/// the token is a stop word,</span>
    <span class="token comment">/// meaning that it can be ignored to optimize size and performance or be indexed as a Word</span>
    <span class="token class-name">StopWord</span><span class="token punctuation">,</span>
    <span class="token comment">/// the token is a separator,</span>
    <span class="token comment">/// meaning that it shouldn't be indexed but used to determine word proximity</span>
    <span class="token class-name">Separator</span><span class="token punctuation">(</span><span class="token class-name">SeparatorKind</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Unknown</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The emitted token position is relative to the original text, this information is reliable. The <code>word</code> is normalized if need be.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[derive(Debug, Clone, Default)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Token</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> kind<span class="token punctuation">:</span> <span class="token class-name">TokenKind</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> word<span class="token punctuation">:</span> <span class="token class-name">Cow</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token keyword">str</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token comment">/// index of the first character of the word</span>
    <span class="token keyword">pub</span> char_index<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    <span class="token comment">/// indexes of start and end of the byte slice</span>
    <span class="token keyword">pub</span> byte_start<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> byte_end<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span> <span class="token class-name">Token</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// return the normalized version of the token</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">text</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token keyword">str</span> <span class="token punctuation">{</span> <span class="token macro property">unimplemented!</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>

    <span class="token comment">// return the size in byte of the original text</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">byte_len</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">usize</span> <span class="token punctuation">{</span> <span class="token macro property">unimplemented!</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>

    <span class="token comment">// return the TokenKind of the token</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">kind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">TokenKind</span> <span class="token punctuation">{</span> <span class="token macro property">unimplemented!</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>

    <span class="token comment">// return true if the TokenKind of the token is TokenKind::Word</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">is_word</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span> <span class="token macro property">unimplemented!</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>

    <span class="token comment">// return Some(SeparatorKind) if the TokenKind of the token is TokenKind::Separator(SeparatorKind),</span>
    <span class="token comment">// None if the token is not a separator</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">is_separator</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">SeparatorKind</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token macro property">unimplemented!</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>

    <span class="token comment">// return true if the TokenKind of the token is TokenKind::StopWord</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">is_stopword</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span> <span class="token macro property">unimplemented!</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="internal-tokenizer-trait"><a href="#internal-tokenizer-trait" class="header-anchor">#</a> Internal Tokenizer trait</h4> <p>The <code>InternalTokenizer</code> trait provides a common interface to adapt other tokenizers to the tokenizer. This allows the extensibility of the current tokenizer to other languages.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">/// iterator over tokens processed by the specialized tokenizer</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">TokenStream</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> inner<span class="token punctuation">:</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">Iterator</span><span class="token operator">&lt;</span><span class="token class-name">Item</span> <span class="token operator">=</span> <span class="token class-name">Token</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;&gt;</span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span> <span class="token class-name">Iterator</span> <span class="token keyword">for</span> <span class="token class-name">TokenStream</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token type-definition class-name">Item</span> <span class="token operator">=</span> <span class="token class-name">Token</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">next</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Item</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>inner<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/// trait defining an internal tokenizer,</span>
<span class="token comment">/// an internal tokenizer should be a script specialized tokenizer,</span>
<span class="token comment">/// this should be implemented as an `Iterator` with `Token` as `Item`,</span>
<span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">Tokenizer</span><span class="token punctuation">:</span> <span class="token class-name">Sync</span> <span class="token operator">+</span> <span class="token class-name">Send</span> <span class="token punctuation">{</span>
    <span class="token comment">/// create the tokenizer based on the given `text` and `char_index`</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">tokenize</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> s<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">ProcessedText</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">TokenStream</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>use of <code>jieba</code> for Chinese tokenization</li> <li>use of <code>unicode-segmenter</code> for other segmentations</li></ul> <h3 id="corner-cases"><a href="#corner-cases" class="header-anchor">#</a> Corner Cases</h3> <p>In some languages like Chinese, there can be multiple &quot;words&quot; extracted that are considered to be at the same position in the text. For example, è®¡ç®æ gives è®¡ç® and è®¡ç®æ, that are at the same position in the text but don't have the same length, the tokenizer should support that behavior. See #5.</p> <blockquote><p>return several token as the same word_position seems to be over-engineering, we may want to have only 1 token by iteration making API simplier</p></blockquote> <h2 id="future-possibilities"><a href="#future-possibilities" class="header-anchor">#</a> Future possibilities</h2> <ul><li>We should add a way to configure the tokenizer to enforce a specific language/script</li> <li>We should add a way to configure tokenizer whitelisting/blacklisting separators</li> <li>The tokenizer specified here is based on scripts, we should base it on languages to be able to have default stop-words for each language</li> <li>The chinese tokenizer is a complicated subject. The first implementation will simply adapt jieba's <code>cut</code> method. In another <a href="https://github.com/meilisearch/specifications/pull/5" target="_blank" rel="noopener noreferrer">specification<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, we'll think about improving this, and this will probably require the help of a native mandarin speaker input.</li> <li>We will want in the future to allow user configuration for the tokenizer. This is taken into account in the design of the new Tokenizer.</li> <li>Normalized synonyms (#964)</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â
      <a href="/specifications/text/0001-frontend-disable-prod.html" class="prev">
        Frontend disable prod
      </a></span> <span class="next"><a href="/specifications/text/0028-indexing-csv.html">
        Indexing csv
      </a>
      â
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.14e18415.js" defer></script><script src="/assets/js/3.7860be15.js" defer></script><script src="/assets/js/13.569b541d.js" defer></script>
  </body>
</html>
